# Agent 工作流编排规则

> 适用范围：所有 Agent 会话（Claude Code / Codex / Gemini）
> 互补规则：[agent-discipline.md](./agent-discipline.md)（执行级纪律）

---

## 工作流编排

### 1. Plan 模式默认策略

- 任何**非简单**任务（≥3 步骤或涉及架构决策）都进入 Plan 模式
- 如果事情开始跑偏，立刻**停止**并重新规划——不要硬推
- Plan 模式不仅用于"做"，也用于**验证步骤**
- 先写清楚详细规格，减少歧义

### 2. 子代理策略

- 大量使用子代理，让主上下文窗口保持干净
- 将调研、探索、并行分析下放给子代理
- 面对复杂问题，通过子代理"加算力"来推进
- 每个子代理只做一件事，保证执行聚焦

### 3. 自我改进循环

- 用户每次纠正后：按既定模式更新 `tasks/lessons.md`
- 给自己写规则，防止重复同样的错误
- 对经验教训进行"无情迭代"，直到错误率下降
- 每次会话开始时，先复盘与当前项目相关的 lessons

### 4. 完成前必须验证

- 没有证明"能工作"，就**不要**标记任务完成
- 需要时，对比主分支与改动后的行为差异（diff behavior）
- 问自己一句："资深工程师会批准这个吗？"
- 跑测试、查日志、展示正确性证据

### 5. 追求优雅（平衡版）

- 对非简单改动：停一下，问"有没有更优雅的做法？"
- 如果修复看起来很 hack：问自己——"以我掌握的全部信息，应该直接实现那个优雅方案"
- 对明显简单的修复跳过这一条——不要过度工程化
- 在提交前先挑战自己的方案质量

### 6. 自主修 Bug

- 收到 bug 报告：直接修，不要让用户手把手带
- 指向日志、错误信息、失败测试——然后把问题解决掉
- 不要求用户进行任何上下文切换
- CI 测试挂了就去修，不需要别人告诉你怎么修

---

## 任务管理

1. **先写计划** — 把计划写到 `tasks/todo.md`，用可勾选条目
2. **验证计划** — 开始实现前先"回报/确认"一次
3. **跟踪进度** — 边做边把条目标记完成
4. **解释改动** — 每一步给出高层摘要
5. **记录结果** — 在 `tasks/todo.md` 添加 review 小节
6. **沉淀经验** — 被纠正后更新 `tasks/lessons.md`

---

## 核心原则

- **简单优先** — 每次改动尽可能简单，改动范围/影响尽量小
- **拒绝偷懒** — 追根溯源，不做临时修补；按资深开发标准交付
- **最小影响** — 只改必须改的部分，避免引入新 bug
